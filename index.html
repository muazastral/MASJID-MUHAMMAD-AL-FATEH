<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penjana Sijil Al-Fateh - Reka Bentuk Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Professional Serif & Sans Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,500;0,700;1,500&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#C5A065',
                            dark: '#0F2412',
                            light: '#F5F5F0',
                            gray: '#8C8C8C'
                        }
                    },
                    fontFamily: {
                        'serif-display': ['"Playfair Display"', 'serif'],
                        'serif-header': ['"Cinzel"', 'serif'],
                        'sans-body': ['"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* A4 Size Fix for Screen */
        .page-container {
            width: 842px;
            /* 297mm landscapeish */
            height: 595px;
            /* 210mm */
            overflow: hidden;
            background-color: #F5F5F0;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar vertical text */
        .vertical-text-container {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vertical-text {
            transform: rotate(-90deg);
            white-space: nowrap;
            /* width: 400px; */
            /* Ensure enough width for rotation */
            text-align: center;
        }

        /* Print Override */
        @media print {
            body * {
                visibility: hidden;
            }

            #certificate-preview,
            #certificate-preview * {
                visibility: visible;
            }

            #certificate-preview {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0;
                box-shadow: none;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-slate-800 font-sans-body p-8">

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 bg-brand-dark/95 z-50 flex-col items-center justify-center text-white hidden">
        <div class="w-12 h-12 border-4 border-brand-gold border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="tracking-widest uppercase text-sm">Sedang Memproses...</p>
    </div>

    <div id="app" class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- CONTROL PANEL -->
        <div class="lg:col-span-3 space-y-6">
            <header>
                <h1 class="text-2xl font-bold text-brand-dark font-serif-header">Penjana Sijil</h1>
                <p class="text-xs text-gray-500 mt-1">Sistem Pengurusan Sijil Digital</p>
            </header>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <div class="space-y-4">
                    <!-- Section 1: Data Source -->
                    <div>
                        <h3 class="text-xs font-bold text-brand-dark uppercase tracking-wider mb-2">1. Logo & Data</h3>
                        <div class="flex flex-col gap-2">
                            <!-- Logo Upload -->
                            <label
                                class="flex items-center justify-between px-3 py-2 bg-gray-50 border border-gray-200 rounded cursor-pointer hover:bg-gray-100 transition">
                                <span class="text-xs text-gray-500 font-medium">Muat Naik Logo</span>
                                <input type="file" id="upload-logo" accept="image/*" class="hidden">
                                <div class="w-4 h-4 bg-gray-200 rounded-full flex items-center justify-center">
                                    <span class="text-[8px] text-gray-500">+</span>
                                </div>
                            </label>

                            <label
                                class="flex items-center justify-center px-4 py-2 bg-gray-50 border border-dashed border-gray-300 rounded cursor-pointer hover:bg-gray-100 transition">
                                <span class="text-xs text-gray-500">Pilih fail CSV</span>
                                <input type="file" id="csv-file" accept=".csv" class="hidden">
                            </label>
                            <button id="btn-download-template"
                                class="w-full px-4 py-2 bg-white border border-gray-200 rounded text-xs font-bold text-brand-dark hover:bg-gray-50 transition">
                                Muat Turun Templat CSV (Nama & No. IC)
                            </button>
                            <div id="csv-status"
                                class="hidden text-[10px] text-green-600 font-medium text-center bg-green-50 py-1 rounded">
                                <span id="record-count">0</span> rekod dijumpai
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Certificate Details -->
                    <div>
                        <h3 class="text-xs font-bold text-brand-dark uppercase tracking-wider mb-2">2. Maklumat Program
                        </h3>
                        <div class="space-y-2">
                            <input type="text" id="input-program" class="w-full text-xs p-2 border rounded bg-gray-50"
                                placeholder="Nama Program" value="Bengkel Kecerdasan Buatan">
                            <textarea id="input-desc" rows="3" class="w-full text-xs p-2 border rounded bg-gray-50"
                                placeholder="Penerangan">Anugerah ini diberikan sebagai pengiktirafan atas komitmen cemerlang dalam menguasai teknologi AI moden.</textarea>
                        </div>
                    </div>

                    <!-- New Section: Signer Details -->
                    <div class="pt-4 border-t border-gray-100">
                        <h3 class="text-xs font-bold text-brand-dark uppercase tracking-wider mb-2">3. Penandatangan
                        </h3>
                        <div class="space-y-2">
                            <label
                                class="flex items-center justify-between px-3 py-2 bg-gray-50 border border-gray-200 rounded cursor-pointer hover:bg-gray-100 transition">
                                <span class="text-xs text-gray-500 font-medium">Muat Naik E-Sign (PNG)</span>
                                <input type="file" id="upload-sign" accept="image/*" class="hidden">
                                <div class="w-4 h-4 bg-gray-200 rounded-full flex items-center justify-center">
                                    <span class="text-[8px] text-gray-500">+</span>
                                </div>
                            </label>

                            <input type="text" id="input-signer-header"
                                class="w-full text-xs p-2 border rounded bg-gray-50 font-medium text-gray-600 italic"
                                placeholder="Tajuk (Cth: Pengerusi Program)" value="Pengerusi Program">
                            <input type="text" id="input-signer-name"
                                class="w-full text-xs p-2 border rounded bg-gray-50 font-bold"
                                placeholder="Nama Penandatangan" value="Dr. Ahmad Al-Fateh">
                            <input type="text" id="input-signer-pos"
                                class="w-full text-xs p-2 border rounded bg-gray-50" placeholder="Organisasi"
                                value="Pertubuhan Belia Al-Fateh">
                        </div>
                    </div>

                    <!-- New Section: Verification & Preset -->
                    <div class="pt-4 border-t border-gray-100">
                        <h3 class="text-xs font-bold text-brand-dark uppercase tracking-wider mb-2">4. Pengesahan & Preset
                        </h3>
                        <div class="space-y-2">
                            <input type="url" id="input-verify-url"
                                class="w-full text-xs p-2 border rounded bg-gray-50"
                                placeholder="URL Pengesahan (auto)"
                                value="https://muazastral.github.io/MASJID-MUHAMMAD-AL-FATEH/" readonly>
                            <label class="flex items-center gap-2 text-xs text-gray-600">
                                <input type="checkbox" id="toggle-qr" class="rounded" checked>
                                Papar QR Code
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="input-preset-name"
                                    class="text-xs p-2 border rounded bg-gray-50" placeholder="Nama preset">
                                <button id="btn-save-preset"
                                    class="text-xs font-bold bg-brand-dark text-white rounded px-2 py-2 hover:bg-green-900">Simpan Preset</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="preset-list" class="text-xs p-2 border rounded bg-gray-50">
                                    <option value="">Pilih preset</option>
                                </select>
                                <button id="btn-delete-preset"
                                    class="text-xs font-bold bg-gray-200 text-gray-700 rounded px-2 py-2 hover:bg-gray-300">Padam Preset</button>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Recipient Preview (Renumbering to 5) -->
                    <div>
                        <h3 class="text-xs font-bold text-brand-dark uppercase tracking-wider mb-2">5. Pratonton
                            Individu</h3>
                        <div class="space-y-2">
                            <input type="text" id="input-name" class="w-full text-xs p-2 border rounded font-semibold uppercase"
                                placeholder="Nama Peserta" value="Ahmad Al-Fateh Bin Abdullah">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="input-id" class="text-xs p-2 border rounded"
                                    placeholder="No. IC" value="901010-10-1010">
                                <input type="text" id="input-hours" class="text-xs p-2 border rounded" placeholder="Jam"
                                    value="8 Jam">
                            </div>
                            <input type="text" id="input-date" class="w-full text-xs p-2 border rounded"
                                placeholder="Tarikh" value="25 Januari 2026">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="pt-4 border-t grid grid-cols-1 gap-2">
                        <button id="btn-download-preview"
                            class="w-full py-2 bg-gray-800 text-white rounded text-xs font-bold hover:bg-black transition shadow-lg">
                            Muat Turun PDF (Pratonton)
                        </button>
                        <button id="btn-generate-bulk" disabled
                            class="w-full py-2 bg-brand-dark text-white rounded text-xs font-bold hover:bg-green-900 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Jana Semua (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PREVIEW AREA -->
        <div
            class="lg:col-span-9 flex justify-center items-start bg-gray-200/50 p-8 rounded-2xl overflow-auto border shadow-inner">

            <div id="certificate-preview" class="page-container relative flex">

                <!-- SIDEBAR -->
                <div
                    class="w-[180px] h-full bg-brand-dark text-white flex flex-col items-center py-10 relative z-10 shrink-0">
                    <!-- Top Pattern or Logo -->
                    <div class="w-28 h-28 flex items-center justify-center mb-6 relative group cursor-pointer"
                        onclick="document.getElementById('upload-logo').click()">
                        <!-- Logo: Full size, contain, no crop -->
                        <img id="main-logo-display" src=""
                            class="max-w-full max-h-full object-contain hidden drop-shadow-md z-10">

                        <!-- Placeholder: Circle style -->
                        <div id="main-logo-placeholder"
                            class="w-24 h-24 rounded-full border border-white/20 flex items-center justify-center bg-white/5 transition group-hover:bg-white/10">
                            <span
                                class="font-serif-header text-sm opacity-50 text-center uppercase leading-tight px-2">Muat
                                Naik<br>Logo</span>
                        </div>
                    </div>
                    <div class="-mt-2 text-[7px] uppercase tracking-[0.2em] text-white/70 text-center">
                        Masjid Muhammad Al-Fateh
                    </div>

                    <!-- Vertical Text -->
                    <div class="flex-grow vertical-text-container">
                        <h2
                            class="vertical-text uppercase tracking-[0.3em] text-[10px] font-medium text-white/80 w-[400px]">
                            Sijil Penyertaan Rasmi
                        </h2>
                    </div>

                    <!-- Sidebar Date -->
                    <div class="mt-12 text-center">
                        <div class="text-white/80 text-[9px] uppercase tracking-[0.2em]">Tarikh</div>
                        <div id="display-date-sidebar" class="mt-2 text-white font-serif-display text-sm font-bold">
                            25 Januari 2026
                        </div>
                    </div>
                </div>

                <!-- MAIN CONTENT -->
                <div class="flex-grow bg-brand-light relative flex flex-col p-[52px]">
                    <!-- Watermark -->
                    <div
                        class="absolute inset-0 flex items-center justify-center z-0 pointer-events-none opacity-[0.03]">
                        <svg class="w-96 h-96" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 0l3.09 6.26L22 7.27l-5 4.87 1.18 6.88L12 15.77l-6.18 3.25L7 12.14 2 7.27l6.91-1.01L12 0z" />
                        </svg>
                    </div>

                    <!-- Header -->
                    <div class="relative z-10 mb-4 pt-1 px-2">
                        <div class="inline-block relative">
                            <h1 class="text-5xl font-serif-display font-bold text-brand-dark mb-4 z-10 relative">Sijil
                                Penghargaan</h1>
                            <!-- Decorative Line properly positioned -->
                            <div class="absolute -bottom-1 left-0 w-24 h-1.5 bg-brand-gold/90"></div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="relative z-10 flex-grow flex flex-col justify-center mb-2">
                        <p class="text-gray-500 font-sans-body text-sm mb-4">Sijil ini diperakui dan dianugerahkan
                            kepada</p>

                        <div class="mb-7">
                            <h2 id="display-name"
                                class="text-3xl font-serif-header font-bold text-brand-dark leading-tight">
                                Ahmad Al-Fateh Bin Abdullah
                            </h2>
                            <p class="mt-2 text-sm text-gray-600">
                                No. IC: <span id="display-id-inline" class="font-mono font-semibold text-gray-700">901010-10-1010</span>
                            </p>
                        </div>

                        <p class="text-gray-500 font-sans-body text-sm mb-2">Kerana telah berjaya menamatkan program:
                        </p>
                        <h3 id="display-program"
                            class="text-xl font-bold text-brand-dark mb-4 font-serif-display uppercase tracking-wide">
                            Bengkel Kecerdasan Buatan
                        </h3>

                        <p id="display-desc" class="text-sm text-gray-600 max-w-xl leading-relaxed">
                            Anugerah ini diberikan sebagai pengiktirafan atas komitmen cemerlang dalam menguasai
                            teknologi AI moden.
                        </p>
                    </div>

                    <!-- Footer Data Grid -->
                    <div class="relative z-10 mt-auto grid grid-cols-2 gap-x-12 gap-y-4 pt-5 pb-4 border-t border-gray-300 min-h-[165px]">
                        <!-- Left Col (E-Sign & Details) -->
                        <div class="flex flex-col justify-start items-start">
                            <div class="mt-1 flex flex-col items-start w-full text-left min-h-[130px] justify-start gap-1 pt-1">
                                <!-- Signature Image -->
                                <div class="h-16 mb-1 w-36 flex items-end justify-start -mt-4">
                                    <img id="display-signature"
                                        src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Signature_sample.svg"
                                        class="max-h-full max-w-full opacity-80 object-contain">
                                </div>
                                <!-- Signer Info -->
                                <h4 id="display-signer-name"
                                    class="text-[12px] font-bold text-brand-dark uppercase font-serif-header leading-tight">Dr. Ahmad
                                    Al-Fateh</h4>
                                <p id="display-signer-header"
                                    class="text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-0.5">Pengerusi
                                    Program</p>
                                <p id="display-signer-pos" class="text-[9px] text-gray-600 leading-snug">Pertubuhan Belia Al-Fateh
                                </p>
                            </div>
                        </div>

                        <!-- Right Col (QR Code) -->
                        <div id="qr-block" class="flex flex-col justify-end items-end pl-8 border-l border-gray-200">
                            <div class="flex flex-col items-end">
                                <div class="w-20 h-20 bg-white border border-gray-200 p-2">
                                    <img id="display-qr"
                                        src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https%3A%2F%2Fexample.com%2Fverify%2FAF-2024-001"
                                        class="w-full h-full object-contain" alt="QR">
                                </div>
                                <span class="mt-2 text-[9px] uppercase tracking-wider text-gray-400">Imbas Untuk Sah</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-8">
        <div class="bg-white max-w-md w-full p-8 rounded-2xl shadow-lg border border-gray-200">
            <div class="text-sm uppercase tracking-widest text-gray-400 mb-2">Akses Pentadbir</div>
            <h2 class="text-2xl font-serif-header font-bold text-brand-dark mb-4">Log Masuk</h2>
            <div class="space-y-3">
                <input type="text" id="login-username" class="w-full text-sm p-2 border rounded bg-gray-50"
                    placeholder="Username">
                <input type="password" id="login-password" class="w-full text-sm p-2 border rounded bg-gray-50"
                    placeholder="Password">
                <button id="btn-login"
                    class="w-full py-2 bg-brand-dark text-white rounded text-sm font-bold hover:bg-green-900">Log Masuk</button>
                <p id="login-error" class="text-xs text-red-600 hidden">Maklumat log masuk tidak sah.</p>
            </div>
        </div>
    </div>

    <!-- Verification View (QR landing) -->
    <div id="verify-view" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-8">
        <div class="bg-white max-w-xl w-full p-8 rounded-2xl shadow-lg border border-gray-200 text-center">
            <div class="text-sm uppercase tracking-widest text-gray-400 mb-2">Pengesahan Sijil</div>
            <h2 class="text-2xl font-serif-header font-bold text-brand-dark mb-4">Sijil Disahkan</h2>
            <p class="text-gray-600 mb-6">Sijil ini adalah sah dan direkodkan.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-left space-y-2">
                <div class="text-xs text-gray-500 uppercase">Nama</div>
                <div id="verify-name" class="font-semibold text-brand-dark">-</div>
                <div class="text-xs text-gray-500 uppercase mt-3">No. IC</div>
                <div id="verify-id" class="font-mono text-brand-dark">-</div>
                <div class="text-xs text-gray-500 uppercase mt-3">Nombor Pengesahan</div>
                <div id="verify-number" class="font-mono font-bold text-brand-dark">-</div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC ---

        let csvData = [];
        let currentVerifyNumber = '';
        let currentVerifyKey = '';

        // Element Refs
        const els = {
            inputs: {
                name: document.getElementById('input-name'),
                program: document.getElementById('input-program'),
                desc: document.getElementById('input-desc'),
                id: document.getElementById('input-id'),
                hours: document.getElementById('input-hours'),
                date: document.getElementById('input-date'),
                signerHeader: document.getElementById('input-signer-header'),
                signerName: document.getElementById('input-signer-name'),
                signerPos: document.getElementById('input-signer-pos'),
                verifyUrl: document.getElementById('input-verify-url'),
                toggleQr: document.getElementById('toggle-qr')
            },
            displays: {
                name: document.getElementById('display-name'),
                program: document.getElementById('display-program'),
                desc: document.getElementById('display-desc'),
                id: document.getElementById('display-id'),
                idInline: document.getElementById('display-id-inline'),
                hours: document.getElementById('display-hours'),
                date: document.getElementById('display-date'),
                dateSidebar: document.getElementById('display-date-sidebar'),
                signerHeader: document.getElementById('display-signer-header'),
                signerName: document.getElementById('display-signer-name'),
                signerPos: document.getElementById('display-signer-pos'),
                qr: document.getElementById('display-qr'),
                qrBlock: document.getElementById('qr-block')
            }
        };

        function generateVerifyNumber() {
            const min = 1000000000;
            const max = 9999999999;
            return Math.floor(min + Math.random() * (max - min + 1)).toString();
        }

        function getBaseVerifyUrl() {
            if (window.location.origin && window.location.origin !== 'null') {
                return `${window.location.origin}${window.location.pathname}`;
            }
            return 'https://muazastral.github.io/MASJID-MUHAMMAD-AL-FATEH/';
        }

        // Sync Function
        function updatePreview() {
            Object.keys(els.inputs).forEach(key => {
                let val = els.inputs[key].value;
                if (key === 'name') {
                    val = val.toUpperCase();
                    els.inputs[key].value = val;
                }
                if (els.displays[key]) els.displays[key].innerText = val;
            });
            if (els.displays.idInline) {
                els.displays.idInline.innerText = els.inputs.id.value;
            }
            if (els.displays.dateSidebar) {
                els.displays.dateSidebar.innerText = els.inputs.date.value;
            }
            if (els.displays.qr && els.inputs.verifyUrl) {
                const key = `${els.inputs.name.value}|${els.inputs.id.value}`.trim();
                if (!currentVerifyNumber || currentVerifyKey !== key) {
                    currentVerifyNumber = generateVerifyNumber();
                    currentVerifyKey = key;
                }
                const baseUrl = els.inputs.verifyUrl.value.trim() || getBaseVerifyUrl();
                const params = new URLSearchParams({
                    number: currentVerifyNumber,
                    name: els.inputs.name.value,
                    id: els.inputs.id.value
                });
                const verifyUrl = `${baseUrl}#verify?${params.toString()}`;
                const encoded = encodeURIComponent(verifyUrl);
                els.displays.qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encoded}`;
            }
            if (els.displays.qrBlock && els.inputs.toggleQr) {
                els.displays.qrBlock.style.display = els.inputs.toggleQr.checked ? 'flex' : 'none';
            }
        }

        // Attach Listeners
        Object.values(els.inputs).forEach(input => input.addEventListener('input', updatePreview));

        // Logo Upload Logic
        document.getElementById('upload-logo').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('main-logo-display');
                    const ph = document.getElementById('main-logo-placeholder');

                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    ph.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // Signature Upload Logic
        document.getElementById('upload-sign').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('display-signature');
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Preset Logic (LocalStorage)
        const presetList = document.getElementById('preset-list');
        const presetNameInput = document.getElementById('input-preset-name');

        function getPresets() {
            try {
                return JSON.parse(localStorage.getItem('sijil_presets') || '{}');
            } catch {
                return {};
            }
        }

        function savePresets(presets) {
            localStorage.setItem('sijil_presets', JSON.stringify(presets));
            refreshPresetList();
        }

        function refreshPresetList() {
            const presets = getPresets();
            const current = presetList.value;
            presetList.innerHTML = '<option value="">Pilih preset</option>';
            Object.keys(presets).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                presetList.appendChild(opt);
            });
            if (current) presetList.value = current;
        }

        function applyPreset(data) {
            els.inputs.program.value = data.program || els.inputs.program.value;
            els.inputs.desc.value = data.desc || els.inputs.desc.value;
            els.inputs.date.value = data.date || els.inputs.date.value;
            els.inputs.hours.value = data.hours || els.inputs.hours.value;
            els.inputs.signerHeader.value = data.signerHeader || els.inputs.signerHeader.value;
            els.inputs.signerName.value = data.signerName || els.inputs.signerName.value;
            els.inputs.signerPos.value = data.signerPos || els.inputs.signerPos.value;
            els.inputs.verifyUrl.value = data.verifyUrl || els.inputs.verifyUrl.value;
            if (typeof data.showQr === 'boolean') {
                els.inputs.toggleQr.checked = data.showQr;
            }

            if (data.logoData) {
                const img = document.getElementById('main-logo-display');
                const ph = document.getElementById('main-logo-placeholder');
                img.src = data.logoData;
                img.classList.remove('hidden');
                ph.classList.add('hidden');
            }
            if (data.signData) {
                const img = document.getElementById('display-signature');
                img.src = data.signData;
            }

            updatePreview();
        }

        document.getElementById('btn-save-preset').addEventListener('click', () => {
            const name = presetNameInput.value.trim();
            if (!name) return alert('Sila masukkan nama preset.');

            const logoImg = document.getElementById('main-logo-display');
            const signImg = document.getElementById('display-signature');

            const presets = getPresets();
            presets[name] = {
                program: els.inputs.program.value,
                desc: els.inputs.desc.value,
                date: els.inputs.date.value,
                hours: els.inputs.hours.value,
                signerHeader: els.inputs.signerHeader.value,
                signerName: els.inputs.signerName.value,
                signerPos: els.inputs.signerPos.value,
                verifyUrl: els.inputs.verifyUrl.value,
                showQr: els.inputs.toggleQr.checked,
                logoData: logoImg && !logoImg.classList.contains('hidden') ? logoImg.src : '',
                signData: signImg ? signImg.src : ''
            };
            savePresets(presets);
            presetList.value = name;
        });

        presetList.addEventListener('change', () => {
            const presets = getPresets();
            const data = presets[presetList.value];
            if (data) applyPreset(data);
        });

        document.getElementById('btn-delete-preset').addEventListener('click', () => {
            const name = presetList.value;
            if (!name) return;
            const presets = getPresets();
            delete presets[name];
            savePresets(presets);
            presetList.value = '';
        });

        function initVerificationView() {
            if (!location.hash.startsWith('#verify')) return false;
            const app = document.getElementById('app');
            const view = document.getElementById('verify-view');
            const login = document.getElementById('login-view');
            const query = location.hash.replace('#verify?', '');
            const params = new URLSearchParams(query);
            const name = params.get('name') || '-';
            const id = params.get('id') || '-';
            const number = params.get('number') || '-';

            document.getElementById('verify-name').innerText = name;
            document.getElementById('verify-id').innerText = id;
            document.getElementById('verify-number').innerText = number;

            app.classList.add('hidden');
            login.classList.add('hidden');
            view.classList.remove('hidden');
            return true;
        }

        function initLogin() {
            const app = document.getElementById('app');
            const login = document.getElementById('login-view');
            const error = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');

            const isLocalDev = location.protocol === 'file:' || ['localhost', '127.0.0.1', '::1'].includes(location.hostname);
            const session = isLocalDev || localStorage.getItem('sijil_login') === 'ok';
            if (session) {
                login.classList.add('hidden');
                app.classList.remove('hidden');
            } else {
                login.classList.remove('hidden');
                app.classList.add('hidden');
            }

            btn.addEventListener('click', () => {
                const u = document.getElementById('login-username').value.trim();
                const p = document.getElementById('login-password').value.trim();
                if (u === 'Admin' && p === 'alfateh99admin') {
                    localStorage.setItem('sijil_login', 'ok');
                    error.classList.add('hidden');
                    login.classList.add('hidden');
                    app.classList.remove('hidden');
                } else {
                    error.classList.remove('hidden');
                }
            });
        }

        refreshPresetList();
        if (!initVerificationView()) {
            initLogin();
        }

        // CSV Template Download
        document.getElementById('btn-download-template').addEventListener('click', () => {
            const csvContent = [
                'Nama,No IC',
                'Ahmad Al-Fateh Bin Abdullah,901010-10-1010',
                'Siti Nur Aisyah,920202-02-2020'
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Templat_Sijil_Nama_NoIC.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        // CSV Parser
        document.getElementById('csv-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    if (results.data && results.data.length > 0) {
                        csvData = results.data;
                        document.getElementById('record-count').innerText = csvData.length;
                        document.getElementById('csv-status').classList.remove('hidden');
                        document.getElementById('btn-generate-bulk').disabled = false;

                        // Load first record as preview
                        loadRecord(csvData[0]);
                    }
                }
            });
        });

        // Helper: Smart Key Finder
        function findVal(row, possibleKeys) {
            const keys = Object.keys(row);
            const match = keys.find(k => possibleKeys.some(pk => k.trim().toLowerCase() === pk.toLowerCase()));
            return match ? row[match] : null;
        }

        function loadRecord(row, index = 0) {
            // Smart mapping
            els.inputs.name.value = findVal(row, ['nama', 'name', 'peserta', 'recipient', 'full name', 'fullname']) || Object.values(row)[0] || '';
            els.inputs.id.value = findVal(row, ['id', 'no', 'ref', 'ic', 'kp', 'matric', 'no ic', 'ic number', 'no.ic', 'noic']) || `S-${1000 + index}`;
            const v = findVal(row, ['verify', 'verification', 'no sah', 'no pengesahan', 'verification number', 'no sijil sah']);
            if (v) {
                row.__verify = v;
            } else if (!row.__verify) {
                row.__verify = generateVerifyNumber();
            }
            currentVerifyNumber = row.__verify;
            currentVerifyKey = `${els.inputs.name.value}|${els.inputs.id.value}`.trim();
            // Optional fields
            const h = findVal(row, ['jam', 'hour', 'masa', 'duration', 'tempoh']);
            if (h) els.inputs.hours.value = h;

            const p = findVal(row, ['program', 'tajuk', 'title', 'course', 'kursus']);
            if (p) els.inputs.program.value = p;

            const d = findVal(row, ['tarikh', 'date', 'dated']);
            if (d) els.inputs.date.value = d;

            updatePreview();
        }

        // PDF Generator
        async function generatePDF(filename, returnBlob = false) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('certificate-preview');

            // Target A4 landscape at 300 DPI (px)
            const targetWidth = 3508;
            const targetHeight = 2480;
            const scale = targetWidth / element.offsetWidth;

            // Create a clean, offscreen clone to ensure consistent capture
            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-99999px';
            wrapper.style.top = '0';
            wrapper.style.width = `${element.offsetWidth}px`;
            wrapper.style.height = `${element.offsetHeight}px`;
            wrapper.style.background = '#F5F5F0';
            wrapper.style.margin = '0';
            wrapper.style.padding = '0';
            wrapper.style.zIndex = '-1';

            const clone = element.cloneNode(true);
            clone.style.boxShadow = 'none';
            clone.style.margin = '0';
            clone.style.transform = 'none';
            clone.style.visibility = 'visible';
            clone.style.width = `${element.offsetWidth}px`;
            clone.style.height = `${element.offsetHeight}px`;
            clone.style.backgroundColor = '#F5F5F0';
            clone.style.overflow = 'hidden';
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);

            // Ensure fonts & images are fully loaded before capture
            if (document.fonts && document.fonts.ready) {
                await document.fonts.ready;
            }
            const imgs = Array.from(clone.querySelectorAll('img'));
            await Promise.all(imgs.map(img => (
                img.complete ? Promise.resolve() : new Promise(resolve => {
                    img.onload = img.onerror = resolve;
                })
            )));

            // Wait for fonts (simple hack: tiny timeout usually enough if loaded, but here we rely on window load)

            const width = clone.offsetWidth;
            const height = clone.offsetHeight;

            const canvas = await html2canvas(clone, {
                scale,
                useCORS: true,
                logging: false,
                backgroundColor: '#F5F5F0',
                letterRendering: true,
                width,
                height,
                windowWidth: width,
                windowHeight: height,
                onclone: (clonedDoc) => {
                    // Ensure fonts are visible in clone
                    const el = clonedDoc.getElementById('certificate-preview');
                    el.style.visibility = 'visible';
                    el.style.transform = 'none'; // Reset any transforms
                    el.style.backgroundColor = '#F5F5F0';
                    el.style.boxShadow = 'none';
                    clonedDoc.body.style.margin = '0';
                }
            });

            document.body.removeChild(wrapper);

            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = targetWidth;
            outputCanvas.height = targetHeight;
            const ctx = outputCanvas.getContext('2d');
            ctx.fillStyle = '#F5F5F0';
            ctx.fillRect(0, 0, targetWidth, targetHeight);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);

            const imgData = outputCanvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [targetWidth, targetHeight]
            });

            const safeMargin = 40;
            const drawWidth = targetWidth - (safeMargin * 2);
            const drawHeight = targetHeight - (safeMargin * 2);
            pdf.addImage(imgData, 'PNG', safeMargin, safeMargin, drawWidth, drawHeight);

            if (returnBlob) {
                return pdf.output('blob');
            } else {
                pdf.save(`${filename}.pdf`);
            }
        }

        document.getElementById('btn-download-preview').addEventListener('click', () => {
            generatePDF(`Sijil_Pratonton_${els.inputs.name.value.replace(/\s/g, '_')}`);
        });

        document.getElementById('btn-generate-bulk').addEventListener('click', async () => {
            if (!csvData.length) return;

            const btn = document.getElementById('btn-generate-bulk');
            const loader = document.getElementById('loading');
            const status = document.getElementById('loading-text');

            if (!confirm(`Adakah anda pasti mahu menjana ${csvData.length} sijil? Ini akan memuat turun satu fail ZIP.`)) return;

            btn.disabled = true;
            loader.style.display = 'flex';

            const zip = new JSZip();
            const folder = zip.folder("Sijil_AlFateh");

            try {
                for (let i = 0; i < csvData.length; i++) {
                    const row = csvData[i];
                    loadRecord(row, i); // Load data into view

                    const name = els.inputs.name.value.trim() || `Peserta_${i + 1}`;
                    status.innerText = `Menjana ${i + 1}/${csvData.length}: ${name}`;

                    // Allow DOM to update
                    await new Promise(r => setTimeout(r, 150));

                    const safeName = name.replace(/[^a-z0-9]/gi, '_');
                    const pdfBlob = await generatePDF(`Sijil_${safeName}`, true);

                    folder.file(`Sijil_${safeName}.pdf`, pdfBlob);
                }

                status.innerText = "Sijil siap! Sedang memampatkan ke ZIP...";
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "Sijil_Pukal.zip");

            } catch (e) {
                console.error(e);
                alert("Ralat semasa menjana sijil: " + e.message);
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>
